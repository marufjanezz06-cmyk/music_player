<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>Mini Music ‚Äî iOS-first Player</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#12121a;
      --card:#171725;
      --card2:#1c1c2c;
      --text:#f3f4ff;
      --muted:rgba(243,244,255,.65);
      --muted2:rgba(243,244,255,.45);
      --line:rgba(255,255,255,.08);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --danger:#ff5c7a;
      --good:#3ddc97;

      --r:18px;
      --tap:52px;

      --safeB: env(safe-area-inset-bottom);
      --safeT: env(safe-area-inset-top);
    }
    [data-theme="light"]{
      --bg:#f6f6fb;
      --panel:#ffffff;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#0c0f18;
      --muted:rgba(12,15,24,.65);
      --muted2:rgba(12,15,24,.45);
      --line:rgba(12,15,24,.10);
      --accent:#007aff;
      --accent2:#7c3aed;
      --danger:#e11d48;
      --good:#059669;
      color-scheme: light;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 20% 0%, rgba(167,139,250,.22), transparent 50%),
                  radial-gradient(900px 900px at 90% 10%, rgba(110,231,255,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* iPhone-first canvas */
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      padding: calc(10px + var(--safeT)) 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.2px;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:99px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 4px rgba(110,231,255,.12);
    }
    .chip{
      font-size:12px; padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      color:var(--muted);
    }

    .content{
      position:relative;
      flex:1;
      overflow:hidden;
    }
    .screens{
      position:absolute; inset:0;
      overflow:auto;
      padding: 0 14px calc(160px + var(--safeB)) 14px; /* space for mini player + tabbar */
      -webkit-overflow-scrolling: touch;
    }
    .screen{display:none; padding-bottom:16px;}
    .screen.active{display:block;}

    .section{
      margin-top:10px;
      padding:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: var(--r);
      backdrop-filter: blur(10px);
    }
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .row.wrap{flex-wrap:wrap; align-items:flex-start;}
    .title{
      font-size:14px; font-weight:700; color:var(--text);
    }
    .sub{font-size:12px; color:var(--muted);}
    .hint{font-size:12px; color:var(--muted); line-height:1.35;}
    .hint b{color:var(--text);}
    .hr{height:1px; background:var(--line); margin:12px 0;}

    .btn{
      min-height: var(--tap);
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:650;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:active{transform: scale(.99);}
    .btn.primary{
      border-color: rgba(110,231,255,.25);
      background: linear-gradient(135deg, rgba(110,231,255,.20), rgba(167,139,250,.18));
    }
    .btn.danger{
      border-color: rgba(255,92,122,.28);
      background: rgba(255,92,122,.10);
      color: var(--text);
    }
    .btn.ghost{
      background: transparent;
    }
    .btn.small{
      min-height: 42px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 650;
    }
    .btn.icon{
      width: var(--tap);
      padding:0;
    }

    .input, .select{
      width:100%;
      min-height: var(--tap);
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      color: var(--text);
      outline: none;
    }
    [data-theme="light"] .input, [data-theme="light"] .select{
      background: rgba(12,15,24,.04);
    }
    .input::placeholder{color: var(--muted2);}

    .pillbar{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill{
      padding:9px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .pill.active{
      color: var(--text);
      border-color: rgba(110,231,255,.35);
      background: rgba(110,231,255,.12);
    }

    /* Track cards */
    .tracks{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .track{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      user-select:none;
      touch-action: manipulation;
    }
    .track:active{transform: scale(.995);}
    .cover{
      width:52px; height:52px; border-radius: 14px;
      flex:0 0 auto;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.22));
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .cover img{width:100%; height:100%; object-fit:cover; display:block;}
    .cover .note{
      width:22px; height:22px;
      opacity:.9;
    }
    .tmeta{flex:1; min-width:0;}
    .tname{
      font-weight:750;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tauthor{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge{
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(255,255,255,.03);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge.missing{border-color: rgba(255,92,122,.22); color: rgba(255,92,122,.95); background: rgba(255,92,122,.08);}
    .badge.fav{border-color: rgba(110,231,255,.22); color: var(--text); background: rgba(110,231,255,.10);}
    .actions{
      display:flex; gap:8px; align-items:center;
      flex:0 0 auto;
    }

    /* Bottom tab bar */
    .tabbar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 8px 12px calc(8px + var(--safeB));
      background: rgba(10,10,16,.72);
      border-top:1px solid var(--line);
      backdrop-filter: blur(18px);
      display:flex;
      justify-content:space-around;
      gap:10px;
      z-index: 30;
    }
    [data-theme="light"] .tabbar{background: rgba(255,255,255,.78);}
    .tab{
      flex:1;
      height: 54px;
      border-radius: 16px;
      border:1px solid transparent;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      color: var(--muted);
      user-select:none;
      touch-action: manipulation;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(110,231,255,.28);
      background: rgba(110,231,255,.10);
    }
    .tab svg{opacity:.9;}
    .tab span{font-size:11px; font-weight:650;}

    /* Mini player */
    .mini{
      position:fixed;
      left:12px; right:12px;
      bottom: calc(74px + var(--safeB));
      z-index: 40;
      border-radius: 20px;
      border:1px solid var(--line);
      background: rgba(16,16,26,.70);
      backdrop-filter: blur(22px);
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      user-select:none;
      touch-action: manipulation;
    }
    [data-theme="light"] .mini{background: rgba(255,255,255,.78);}
    .mini.hidden{display:none;}
    .mini .cover{width:44px;height:44px;border-radius:14px;}
    .mini .tname{font-size:13px;}
    .mini .tauthor{font-size:11px;}
    .mini .actions .btn.icon{width:46px; height:46px; border-radius:16px;}

    /* Full Player sheet */
    .sheetOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(3px);
      display:none;
      z-index: 60;
    }
    .sheetOverlay.show{display:block;}
    .sheet{
      position:absolute;
      left:0; right:0;
      bottom:0;
      border-top-left-radius: 26px;
      border-top-right-radius: 26px;
      border:1px solid var(--line);
      border-bottom: none;
      background: rgba(16,16,26,.92);
      backdrop-filter: blur(22px);
      transform: translateY(12px);
      animation: sheetIn .18s ease-out forwards;
      max-height: calc(100% - var(--safeT) - 12px);
      overflow:hidden;
    }
    [data-theme="light"] .sheet{background: rgba(255,255,255,.92);}
    @keyframes sheetIn{
      from{transform: translateY(40px); opacity:.9;}
      to{transform: translateY(0); opacity:1;}
    }
    .sheetHeader{
      padding: 10px 14px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
    }
    .grab{
      width:44px; height:5px; border-radius: 99px;
      background: rgba(255,255,255,.25);
      margin: 6px auto 0;
    }
    [data-theme="light"] .grab{background: rgba(12,15,24,.18);}
    .sheetBody{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 14px calc(18px + var(--safeB)) 14px;
    }

    .bigCover{
      width: 100%;
      aspect-ratio: 1 / 1;
      max-height: 380px;
      border-radius: 22px;
      border: 1px solid var(--line);
      overflow:hidden;
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.22));
      display:grid; place-items:center;
      margin-top:10px;
    }
    .bigCover img{width:100%; height:100%; object-fit:cover; display:block;}
    .bigTitle{
      margin-top:14px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.2px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .bigAuthor{
      margin-top:4px;
      font-size: 13px;
      color: var(--muted);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    .progressWrap{margin-top:14px;}
    .timeRow{display:flex; justify-content:space-between; color:var(--muted); font-size:12px; margin-top:8px;}
    input[type="range"]{
      width:100%;
      height: 34px;
      background: transparent;
      margin: 0;
      padding: 0;
      touch-action: pan-x;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
    }
    [data-theme="light"] input[type="range"]::-webkit-slider-runnable-track{background: rgba(12,15,24,.12);}
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      width: 22px; height: 22px;
      margin-top: -8px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: 1px solid rgba(255,255,255,.25);
      box-shadow: 0 8px 18px rgba(0,0,0,.20);
    }

    .transport{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
    }
    .transport .btn.icon{
      width:60px; height:60px;
      border-radius: 20px;
    }
    .transport .btn.icon.primary{
      width:74px; height:74px;
      border-radius: 24px;
      font-size: 15px;
    }

    .modes{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .modeBtn{
      flex:1;
      min-width: 110px;
    }

    .queuePanel{
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .queueHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .queueList{display:flex; flex-direction:column; gap:8px;}
    .queueItem{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .queueItem .qmeta{flex:1; min-width:0;}
    .queueItem .qname{font-size:13px; font-weight:750; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .queueItem .qauth{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .queueItem .qbtns{display:flex; gap:6px;}

    .toast{
      position:fixed;
      left:12px; right:12px;
      top: calc(12px + var(--safeT));
      z-index: 100;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(16,16,26,.86);
      backdrop-filter: blur(16px);
      color: var(--text);
      display:none;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    [data-theme="light"] .toast{background: rgba(255,255,255,.90);}
    .toast.show{display:block; animation: toastIn .18s ease-out forwards;}
    @keyframes toastIn{
      from{transform: translateY(-8px); opacity:.7;}
      to{transform: translateY(0); opacity:1;}
    }

    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(3px);
      display:none;
      z-index: 80;
    }
    .modalOverlay.show{display:block;}
    .modal{
      position:absolute;
      left:12px; right:12px;
      top: calc(12px + var(--safeT));
      border-radius: 20px;
      border:1px solid var(--line);
      background: rgba(16,16,26,.92);
      backdrop-filter: blur(20px);
      overflow:hidden;
    }
    [data-theme="light"] .modal{background: rgba(255,255,255,.92);}
    .modalHead{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .modalBody{padding: 12px 14px 14px;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .muted{color:var(--muted); font-size:12px; line-height:1.35;}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 6px;
      border:1px solid var(--line);
      border-radius: 8px;
      background: rgba(255,255,255,.05);
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="app" id="app" data-theme="dark">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div style="font-size:14px">Mini Music</div>
          <div class="sub" id="topSub">iOS-first ‚Ä¢ Offline library</div>
        </div>
      </div>
      <div class="chip" id="nowChip">‚Äî</div>
    </div>

    <div class="content">
      <div class="screens" id="screens">

        <!-- LIBRARY -->
        <div class="screen active" id="screen-library">
          <div class="section">
            <div class="row wrap" style="gap:10px">
              <div style="flex:1; min-width:220px">
                <div class="title" id="libTitle">Library</div>
                <div class="sub" id="libSub">Import your music files (local). After refresh you must relink.</div>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
                <label class="btn primary" for="fileInput" id="importBtn">‚¨áÔ∏è Import</label>
                <input id="fileInput" type="file" accept=".mp3,.m4a,.aac,.wav,.ogg,.flac,audio/*" multiple hidden />
                <button class="btn" id="relinkBtn">üîó Relink</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row wrap" style="gap:10px">
              <div style="flex:1; min-width:220px">
                <input class="input" id="searchInput" placeholder="Search title / artist‚Ä¶" />
              </div>
              <div style="flex:0 0 auto; min-width:160px">
                <select class="select" id="sortSelect">
                  <option value="recent">Recent</option>
                  <option value="title">Title A‚ÜíZ</option>
                  <option value="artist">Artist A‚ÜíZ</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px" class="pillbar" id="filterPills">
              <div class="pill active" data-filter="all" id="pillAll">All</div>
              <div class="pill" data-filter="fav" id="pillFav">Favorites</div>
              <div class="pill" data-filter="missing" id="pillMissing">Missing</div>
            </div>

            <div class="tracks" id="trackList"></div>
          </div>
        </div>

        <!-- PLAYLISTS -->
        <div class="screen" id="screen-playlists">
          <div class="section">
            <div class="row wrap" style="gap:10px">
              <div>
                <div class="title" id="plTitle">Playlists</div>
                <div class="sub" id="plSub">Create playlists, reorder with ‚Üë/‚Üì.</div>
              </div>
              <button class="btn primary" id="createPlaylistBtn">‚ûï Create</button>
            </div>

            <div class="hr"></div>

            <div id="playlistViewRoot"></div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div class="screen" id="screen-settings">
          <div class="section">
            <div class="title" id="setTitle">Settings</div>
            <div class="sub" id="setSub">Theme, language, data, help.</div>

            <div class="hr"></div>

            <div class="row wrap">
              <div style="flex:1; min-width:220px">
                <div class="title" id="themeTitle">Theme</div>
                <div class="sub" id="themeSub">Dark / Light</div>
              </div>
              <button class="btn" id="themeToggle">üåô Dark</button>
            </div>

            <div class="hr"></div>

            <div class="row wrap">
              <div style="flex:1; min-width:220px">
                <div class="title" id="langTitle">Language</div>
                <div class="sub" id="langSub">RU / EN</div>
              </div>
              <button class="btn" id="langToggle">üá∑üá∫ RU</button>
            </div>

            <div class="hr"></div>

            <div class="row wrap">
              <div style="flex:1; min-width:220px">
                <div class="title" id="dataTitle">Data</div>
                <div class="sub" id="dataSub">Clear library, playlists, favorites.</div>
              </div>
              <button class="btn danger" id="clearDataBtn">üßπ Clear data</button>
            </div>

            <div class="hr"></div>

            <div class="title" id="helpTitle">Help / iOS notes</div>
            <div class="hint" id="helpBody" style="margin-top:8px"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- Mini Player -->
    <div class="mini hidden" id="miniPlayer" role="button" aria-label="Open player">
      <div class="cover" id="miniCover">
        <svg class="note" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M9 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
          <path d="M12 15V5l9-2v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M18 19a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="tmeta">
        <div class="tname" id="miniTitle">‚Äî</div>
        <div class="tauthor" id="miniArtist">‚Äî</div>
      </div>
      <div class="actions">
        <button class="btn icon" id="miniPlayBtn" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
        <button class="btn icon" id="miniNextBtn" aria-label="Next">‚è≠Ô∏è</button>
      </div>
    </div>

    <!-- Bottom Tab Bar -->
    <div class="tabbar" id="tabbar">
      <div class="tab active" data-tab="library" role="button" aria-label="Library tab">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 4h12v4H6V4Z" stroke="currentColor" stroke-width="2"/>
          <path d="M6 10h12v10H6V10Z" stroke="currentColor" stroke-width="2"/>
        </svg>
        <span id="tabLibrary">Library</span>
      </div>
      <div class="tab" data-tab="playlists" role="button" aria-label="Playlists tab">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 7h16M4 12h10M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span id="tabPlaylists">Playlists</span>
      </div>
      <div class="tab" data-tab="settings" role="button" aria-label="Settings tab">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
          <path d="M19.4 15a8.6 8.6 0 0 0 .1-1 8.6 8.6 0 0 0-.1-1l2-1.6-2-3.4-2.4 1a8.8 8.8 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.8 8.8 0 0 0-1.7 1l-2.4-1-2 3.4 2 1.6a8.6 8.6 0 0 0-.1 1 8.6 8.6 0 0 0 .1 1l-2 1.6 2 3.4 2.4-1a8.8 8.8 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.8 8.8 0 0 0 1.7-1l2.4 1 2-3.4-2-1.6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
        <span id="tabSettings">Settings</span>
      </div>
    </div>

    <!-- Full Player Sheet -->
    <div class="sheetOverlay" id="sheetOverlay" aria-hidden="true">
      <div class="sheet" id="sheet">
        <div class="grab"></div>
        <div class="sheetHeader">
          <button class="btn small ghost" id="closeSheetBtn">‚¨áÔ∏è <span id="closeTxt">Close</span></button>
          <div class="chip" id="sheetChip">Player</div>
          <button class="btn small" id="queueToggleBtn">üßæ <span id="queueTxt">Queue</span></button>
        </div>
        <div class="sheetBody">
          <div class="bigCover" id="bigCover">
            <svg class="note" style="width:46px;height:46px;opacity:.9" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M9 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
              <path d="M12 15V5l9-2v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M18 19a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>

          <div class="bigTitle" id="bigTitle">‚Äî</div>
          <div class="bigAuthor" id="bigArtist">‚Äî</div>

          <div class="progressWrap">
            <input type="range" id="seek" min="0" max="1000" value="0" aria-label="Seek" />
            <div class="timeRow">
              <div id="tCur">0:00</div>
              <div id="tDur">0:00</div>
            </div>
          </div>

          <div class="transport">
            <button class="btn icon" id="prevBtn" aria-label="Previous">‚èÆÔ∏è</button>
            <button class="btn icon primary" id="playBtn" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
            <button class="btn icon" id="nextBtn" aria-label="Next">‚è≠Ô∏è</button>
          </div>

          <div class="modes">
            <button class="btn small modeBtn" id="shuffleBtn">üîÄ <span id="shuffleTxt">Shuffle</span>: <b id="shuffleState">Off</b></button>
            <button class="btn small modeBtn" id="repeatBtn">üîÅ <span id="repeatTxt">Repeat</span>: <b id="repeatState">Off</b></button>
            <button class="btn small modeBtn" id="favBtn">‚≠ê <span id="favTxt">Favorite</span></button>
          </div>

          <div class="section" style="margin-top:12px">
            <div class="row wrap" style="gap:10px">
              <div style="flex:1; min-width:220px">
                <div class="title" id="volTitle">Audio</div>
                <div class="sub" id="volSub">iPhone Safari: system volume often only by hardware buttons.</div>
              </div>
              <button class="btn small" id="muteBtn">üîá <span id="muteTxt">Mute</span></button>
            </div>

            <div class="hr"></div>

            <div class="title" style="font-size:13px" id="gainTitle">Gain (preamp)</div>
            <div class="sub" id="gainSub">Works via WebAudio (if allowed). Use it as ‚Äúboost‚Äù instead of system volume.</div>
            <div style="margin-top:8px">
              <input type="range" id="gain" min="0" max="200" value="100" />
              <div class="timeRow">
                <div class="muted" id="gainLeft">0%</div>
                <div class="muted" id="gainRight">200%</div>
              </div>
              <div class="hint" id="volumeHint" style="margin-top:8px"></div>
            </div>
          </div>

          <div class="section" style="margin-top:12px">
            <div class="row wrap" style="gap:10px">
              <div style="flex:1; min-width:220px">
                <div class="title" id="metaTitle">Track info</div>
                <div class="sub" id="metaSub">No ID3 parsing. Title = filename. Edit manually.</div>
              </div>
              <button class="btn small" id="editInfoBtn">‚úèÔ∏è <span id="editTxt">Edit info</span></button>
            </div>

            <div class="hr"></div>

            <div class="row wrap" style="gap:10px">
              <button class="btn small" id="addToPlaylistBtn">‚ûï <span id="addPlTxt">Add to playlist</span></button>
              <button class="btn small" id="assignCatBtn">üè∑Ô∏è <span id="catTxt">Assign category</span></button>
            </div>
          </div>

          <div class="queuePanel" id="queuePanel" style="display:none;">
            <div class="queueHeader">
              <div>
                <div class="title" id="queueTitle">Queue</div>
                <div class="sub" id="queueSub">Reorder with ‚Üë/‚Üì (drag optional not used).</div>
              </div>
              <button class="btn small" id="clearQueueBtn">üóëÔ∏è <span id="clearQueueTxt">Clear</span></button>
            </div>
            <div class="queueList" id="queueList"></div>
          </div>

        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
      <div class="modal" id="modal">
        <div class="modalHead">
          <div class="title" id="modalTitle">‚Äî</div>
          <button class="btn small ghost" id="modalCloseBtn">‚úñÔ∏è</button>
        </div>
        <div class="modalBody" id="modalBody"></div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Hidden audio -->
    <audio id="audio" preload="metadata" playsinline></audio>
  </div>

  <script>
  (() => {
    'use strict';

    // ========= Utils =========
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const now = () => Date.now();
    const fmtTime = (sec) => {
      sec = isFinite(sec) ? Math.max(0, sec) : 0;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,'0')}`;
    };
    const uid = () => Math.random().toString(36).slice(2, 10) + Math.random().toString(36).slice(2, 6);

    // ========= i18n =========
    const I18N = {
      ru: {
        topSub: 'iOS-first ‚Ä¢ Offline library',
        nowChip: (n) => `${n} —Ç—Ä–µ–∫(–æ–≤)`,
        tabs: { library:'Library', playlists:'Playlists', settings:'Settings' },

        libTitle:'Library',
        libSub:'–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π –º—É–∑—ã–∫—É (–ª–æ–∫–∞–ª—å–Ω–æ). –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –Ω—É–∂–Ω–æ Relink.',
        import:'‚¨áÔ∏è Import',
        relink:'üîó Relink',
        searchPh:'–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–∞–≤—Ç–æ—Ä—É‚Ä¶',
        all:'All', fav:'Favorites', missing:'Missing',
        recent:'Recent', titleAZ:'Title A‚ÜíZ', artistAZ:'Artist A‚ÜíZ',

        plTitle:'Playlists',
        plSub:'–°–æ–∑–¥–∞–≤–∞–π –ø–ª–µ–π–ª–∏—Å—Ç—ã, –ø–æ—Ä—è–¥–æ–∫ –º–µ–Ω—è–π ‚Üë/‚Üì.',
        create:'‚ûï Create',

        setTitle:'Settings',
        setSub:'–¢–µ–º–∞, —è–∑—ã–∫, –¥–∞–Ω–Ω—ã–µ, –ø–æ–º–æ—â—å.',
        themeTitle:'Theme', themeSub:'Dark / Light',
        langTitle:'Language', langSub:'RU / EN',
        dataTitle:'Data', dataSub:'–û—á–∏—Å—Ç–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É/–ø–ª–µ–π–ª–∏—Å—Ç—ã/–∏–∑–±—Ä–∞–Ω–Ω–æ–µ.',
        clear:'üßπ Clear data',
        helpTitle:'Help / iOS notes',
        helpBody: `
          <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b><br/>
          1) –í <b>Library</b> –Ω–∞–∂–º–∏ <b>Import</b> –∏ –≤—ã–±–µ—Ä–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã.<br/>
          2) –¢–∞–ø –ø–æ —Ç—Ä–µ–∫—É ‚Üí –Ω–∞—á–Ω—ë—Ç –∏–≥—Ä–∞—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å.<br/>
          3) –í–Ω–∏–∑—É –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω <b>mini-player</b> ‚Üí —Ç–∞–ø/—Å–≤–∞–π–ø –≤–≤–µ—Ä—Ö –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø–ª–µ–µ—Ä.<br/>
          4) –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ñ–∞–π–ª—ã —Å—Ç–∞–Ω—É—Ç <b>Missing</b> (ObjectURL –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è) ‚Üí –Ω–∞–∂–º–∏ <b>Relink</b> –∏ –≤—ã–±–µ—Ä–∏ —Ç–µ –∂–µ —Ñ–∞–π–ª—ã —Å–Ω–æ–≤–∞ (–ø–æ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ: –∏–º—è + —Ä–∞–∑–º–µ—Ä + lastModified).<br/><br/>
          <b>–ì—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∞ iPhone:</b> —Å–∏—Å—Ç–µ–º–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å —á–∞—Å—Ç–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å <b>Mute</b> –∏ <b>Gain (preamp)</b> —á–µ—Ä–µ–∑ WebAudio (—ç—Ç–æ ‚Äú—É—Å–∏–ª–µ–Ω–∏–µ‚Äù, –Ω–µ —Å–∏—Å—Ç–µ–º–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å).<br/><br/>
          <b>–û—Ñ—Ñ–ª–∞–π–Ω:</b> –¥–∞–Ω–Ω—ã–µ –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ/–ø–ª–µ–π–ª–∏—Å—Ç–∞—Ö —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ <span class="kbd">localStorage</span>. –°–∞–º–∏ —Ñ–∞–π–ª—ã Safari –Ω–µ —Ö—Ä–∞–Ω–∏—Ç ‚Äî –Ω—É–∂–Ω–æ relink.<br/>
        `,

        unknown:'Unknown Artist',
        missingBadge:'Missing',
        favBadge:'Favorite',

        close:'Close',
        queue:'Queue',
        shuffle:'Shuffle',
        repeat:'Repeat',
        favorite:'Favorite',

        audio:'Audio',
        audioSub:'iPhone Safari: —Å–∏—Å—Ç–µ–º–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å —á–∞—Å—Ç–æ —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.',
        mute:'Mute',
        unmute:'Unmute',
        gainTitle:'Gain (preamp)',
        gainSub:'–†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ WebAudio (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ). –ò—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ ‚Äú—É—Å–∏–ª–µ–Ω–∏–µ‚Äù.',

        metaTitle:'Track info',
        metaSub:'–ë–µ–∑ ID3. Title = –∏–º—è —Ñ–∞–π–ª–∞. –ú–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é.',
        edit:'Edit info',
        addToPlaylist:'Add to playlist',
        category:'Assign category',

        queueTitle:'Queue',
        queueSub:'–ú–µ–Ω—è–π –ø–æ—Ä—è–¥–æ–∫ ‚Üë/‚Üì (drag –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º).',
        clearQueue:'Clear',

        toasts: {
          imported: (n)=>`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${n}`,
          relinked: (n)=>`Relink: –Ω–∞–π–¥–µ–Ω–æ ${n}`,
          needRelink:'–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–∫–∏ Missing ‚Äî –Ω–∞–∂–º–∏ Relink –∏ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª—ã —Å–Ω–æ–≤–∞.',
          cannotPlayMissing:'–§–∞–π–ª Missing. –ù—É–∂–µ–Ω Relink.',
          createdPlaylist:'–ü–ª–µ–π–ª–∏—Å—Ç —Å–æ–∑–¥–∞–Ω',
          updated:'–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ',
          cleared:'–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã'
        },

        modal: {
          createPlaylist:'Create playlist',
          playlistName:'Playlist name',
          create:'Create',
          cancel:'Cancel',
          open:'Open',
          back:'‚Üê Back',
          rename:'Rename',
          delete:'Delete',
          add:'Add',
          remove:'Remove',
          pickPlaylist:'Pick playlist',
          assignCategory:'Assign category',
          categoryName:'Category name',
          save:'Save',
          editInfo:'Edit track info',
          title:'Title',
          artist:'Artist',
          cover:'Cover image (optional)',
          setCover:'Set cover',
          clearCover:'Clear cover',
          relinkTitle:'Relink files',
          relinkBody:'–í—ã–±–µ—Ä–∏ —Ç–µ –∂–µ —Ñ–∞–π–ª—ã —Å–Ω–æ–≤–∞. –ú—ã —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º –ø–æ (name + size + lastModified).',
          relinkBtn:'Relink now',
          ok:'OK'
        },

        playlistEmpty:'No playlists yet.',
        playlistTracksEmpty:'No tracks in this playlist.',
        openPlaylist:'Open',
        addFromLibrary:'–î–æ–±–∞–≤—å —Ç—Ä–µ–∫–∏ –∏–∑ Library –∏–ª–∏ —á–µ—Ä–µ–∑ Full Player ‚Üí Add to playlist.',
      },
      en: {
        topSub: 'iOS-first ‚Ä¢ Offline library',
        nowChip: (n) => `${n} track(s)`,
        tabs: { library:'Library', playlists:'Playlists', settings:'Settings' },

        libTitle:'Library',
        libSub:'Import your music files (local). After refresh you must relink.',
        import:'‚¨áÔ∏è Import',
        relink:'üîó Relink',
        searchPh:'Search title / artist‚Ä¶',
        all:'All', fav:'Favorites', missing:'Missing',
        recent:'Recent', titleAZ:'Title A‚ÜíZ', artistAZ:'Artist A‚ÜíZ',

        plTitle:'Playlists',
        plSub:'Create playlists, reorder with ‚Üë/‚Üì.',
        create:'‚ûï Create',

        setTitle:'Settings',
        setSub:'Theme, language, data, help.',
        themeTitle:'Theme', themeSub:'Dark / Light',
        langTitle:'Language', langSub:'RU / EN',
        dataTitle:'Data', dataSub:'Clear library, playlists, favorites.',
        clear:'üßπ Clear data',
        helpTitle:'Help / iOS notes',
        helpBody: `
          <b>How to use:</b><br/>
          1) In <b>Library</b> tap <b>Import</b> and pick audio files.<br/>
          2) Tap a track ‚Üí plays + adds to queue.<br/>
          3) Bottom <b>mini-player</b> is always visible ‚Üí tap / swipe up to open full player.<br/>
          4) After page reload, files become <b>Missing</b> (ObjectURL can‚Äôt be saved) ‚Üí press <b>Relink</b> and pick the same files again (signature: name + size + lastModified).<br/><br/>
          <b>iPhone volume:</b> system volume is often controlled only by hardware buttons. This app provides <b>Mute</b> and <b>Gain (preamp)</b> via WebAudio (boost, not system volume).<br/><br/>
          <b>Offline:</b> library/playlists stored in <span class="kbd">localStorage</span>. Safari does not keep your files ‚Äî you must relink.<br/>
        `,

        unknown:'Unknown Artist',
        missingBadge:'Missing',
        favBadge:'Favorite',

        close:'Close',
        queue:'Queue',
        shuffle:'Shuffle',
        repeat:'Repeat',
        favorite:'Favorite',

        audio:'Audio',
        audioSub:'iPhone Safari: system volume often only via phone buttons.',
        mute:'Mute',
        unmute:'Unmute',
        gainTitle:'Gain (preamp)',
        gainSub:'Works via WebAudio (if allowed). Use as ‚Äúboost‚Äù.',

        metaTitle:'Track info',
        metaSub:'No ID3. Title = filename. Edit manually.',
        edit:'Edit info',
        addToPlaylist:'Add to playlist',
        category:'Assign category',

        queueTitle:'Queue',
        queueSub:'Reorder with ‚Üë/‚Üì (no drag).',
        clearQueue:'Clear',

        toasts: {
          imported: (n)=>`Imported: ${n}`,
          relinked: (n)=>`Relink: matched ${n}`,
          needRelink:'Some tracks are Missing ‚Äî tap Relink and pick files again.',
          cannotPlayMissing:'File is Missing. Please Relink.',
          createdPlaylist:'Playlist created',
          updated:'Saved',
          cleared:'Data cleared'
        },

        modal: {
          createPlaylist:'Create playlist',
          playlistName:'Playlist name',
          create:'Create',
          cancel:'Cancel',
          open:'Open',
          back:'‚Üê Back',
          rename:'Rename',
          delete:'Delete',
          add:'Add',
          remove:'Remove',
          pickPlaylist:'Pick playlist',
          assignCategory:'Assign category',
          categoryName:'Category name',
          save:'Save',
          editInfo:'Edit track info',
          title:'Title',
          artist:'Artist',
          cover:'Cover image (optional)',
          setCover:'Set cover',
          clearCover:'Clear cover',
          relinkTitle:'Relink files',
          relinkBody:'Pick the same files again. We match by (name + size + lastModified).',
          relinkBtn:'Relink now',
          ok:'OK'
        },

        playlistEmpty:'No playlists yet.',
        playlistTracksEmpty:'No tracks in this playlist.',
        openPlaylist:'Open',
        addFromLibrary:'Add tracks from Library or via Full Player ‚Üí Add to playlist.',
      }
    };

    // ========= Storage =========
    const KEY = 'mini_music_v1';
    const load = () => {
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    };
    const save = (obj) => {
      localStorage.setItem(KEY, JSON.stringify(obj));
    };

    // ========= App state =========
    const appEl = $('#app');
    const audio = $('#audio');

    const isIOS = (() => {
      const ua = navigator.userAgent || '';
      return /iPhone|iPad|iPod/i.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    })();

    let state = {
      settings: {
        theme: 'dark',
        lang: 'ru',
        lastPlayedId: null,
        shuffle: false,
        repeat: 'off', // off | all | one
        muted: false,
        gain: 1.0, // 0..2
      },
      library: {
        tracks: [] // {id, sig:{name,size,mod}, title, artist, coverDataUrl|null, category:'', fav:false, missing:true, addedAt}
      },
      playlists: {
        byId: {}, // id -> {id, name, trackIds:[]}
        order: []  // playlist ids
      },
      queue: {
        ids: [],
        index: -1
      }
    };

    // ========= WebAudio gain (iOS-friendly) =========
    let audioCtx = null;
    let gainNode = null;
    let sourceNode = null;
    let webAudioReady = false;

    function ensureWebAudio() {
      if(webAudioReady) return true;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return false;
      try{
        audioCtx = audioCtx || new Ctx();
        // must be resumed by user gesture on iOS
        if(audioCtx.state === 'suspended') {
          // resume will be called in a user gesture handler
        }
        gainNode = gainNode || audioCtx.createGain();
        gainNode.gain.value = state.settings.muted ? 0 : state.settings.gain;

        if(!sourceNode){
          sourceNode = audioCtx.createMediaElementSource(audio);
          sourceNode.connect(gainNode).connect(audioCtx.destination);
        }
        webAudioReady = true;
        return true;
      }catch(e){
        // If MediaElementSource fails (can happen if recreated), fallback silently
        return false;
      }
    }

    async function resumeAudioContextIfNeeded() {
      if(!audioCtx) return;
      if(audioCtx.state === 'suspended') {
        try { await audioCtx.resume(); } catch(e) {}
      }
    }

    // ========= ObjectURL map (not persisted) =========
    const urlMap = new Map(); // trackId -> objectURL
    const revokeAllUrls = () => {
      for(const u of urlMap.values()){
        try{ URL.revokeObjectURL(u); }catch(e){}
      }
      urlMap.clear();
    };
    window.addEventListener('beforeunload', () => revokeAllUrls());

    // ========= UI refs =========
    const screens = $('#screens');
    const trackList = $('#trackList');
    const playlistViewRoot = $('#playlistViewRoot');

    const fileInput = $('#fileInput');
    const relinkBtn = $('#relinkBtn');
    const searchInput = $('#searchInput');
    const sortSelect = $('#sortSelect');
    const filterPills = $('#filterPills');

    const miniPlayer = $('#miniPlayer');
    const miniTitle = $('#miniTitle');
    const miniArtist = $('#miniArtist');
    const miniCover = $('#miniCover');
    const miniPlayBtn = $('#miniPlayBtn');
    const miniNextBtn = $('#miniNextBtn');

    const sheetOverlay = $('#sheetOverlay');
    const closeSheetBtn = $('#closeSheetBtn');
    const queueToggleBtn = $('#queueToggleBtn');
    const queuePanel = $('#queuePanel');
    const queueList = $('#queueList');

    const bigCover = $('#bigCover');
    const bigTitle = $('#bigTitle');
    const bigArtist = $('#bigArtist');
    const seek = $('#seek');
    const tCur = $('#tCur');
    const tDur = $('#tDur');
    const playBtn = $('#playBtn');
    const prevBtn = $('#prevBtn');
    const nextBtn = $('#nextBtn');

    const shuffleBtn = $('#shuffleBtn');
    const repeatBtn = $('#repeatBtn');
    const shuffleState = $('#shuffleState');
    const repeatState = $('#repeatState');
    const favBtn = $('#favBtn');

    const muteBtn = $('#muteBtn');
    const gain = $('#gain');
    const volumeHint = $('#volumeHint');

    const editInfoBtn = $('#editInfoBtn');
    const addToPlaylistBtn = $('#addToPlaylistBtn');
    const assignCatBtn = $('#assignCatBtn');
    const clearQueueBtn = $('#clearQueueBtn');

    const themeToggle = $('#themeToggle');
    const langToggle = $('#langToggle');
    const clearDataBtn = $('#clearDataBtn');

    const nowChip = $('#nowChip');
    const toast = $('#toast');

    const modalOverlay = $('#modalOverlay');
    const modalTitle = $('#modalTitle');
    const modalBody = $('#modalBody');
    const modalCloseBtn = $('#modalCloseBtn');

    // ========= i18n apply =========
    function t() { return I18N[state.settings.lang] || I18N.ru; }

    function applyTexts() {
      const L = t();

      $('#topSub').textContent = L.topSub;
      $('#tabLibrary').textContent = L.tabs.library;
      $('#tabPlaylists').textContent = L.tabs.playlists;
      $('#tabSettings').textContent = L.tabs.settings;

      $('#libTitle').textContent = L.libTitle;
      $('#libSub').textContent = L.libSub;
      $('#importBtn').textContent = L.import;
      $('#relinkBtn').textContent = L.relink;
      $('#searchInput').placeholder = L.searchPh;

      $('#pillAll').textContent = L.all;
      $('#pillFav').textContent = L.fav;
      $('#pillMissing').textContent = L.missing;

      // sort select labels (keep values)
      const opts = $$('#sortSelect option');
      if(opts[0]) opts[0].textContent = L.recent;
      if(opts[1]) opts[1].textContent = L.titleAZ;
      if(opts[2]) opts[2].textContent = L.artistAZ;

      $('#plTitle').textContent = L.plTitle;
      $('#plSub').textContent = L.plSub;
      $('#createPlaylistBtn').textContent = L.create;

      $('#setTitle').textContent = L.setTitle;
      $('#setSub').textContent = L.setSub;
      $('#themeTitle').textContent = L.themeTitle;
      $('#themeSub').textContent = L.themeSub;
      $('#langTitle').textContent = L.langTitle;
      $('#langSub').textContent = L.langSub;
      $('#dataTitle').textContent = L.dataTitle;
      $('#dataSub').textContent = L.dataSub;
      $('#clearDataBtn').textContent = L.clear;
      $('#helpTitle').textContent = L.helpTitle;
      $('#helpBody').innerHTML = L.helpBody;

      $('#closeTxt').textContent = L.close;
      $('#queueTxt').textContent = L.queue;
      $('#shuffleTxt').textContent = L.shuffle;
      $('#repeatTxt').textContent = L.repeat;
      $('#favTxt').textContent = L.favorite;

      $('#volTitle').textContent = L.audio;
      $('#volSub').textContent = L.audioSub;
      $('#gainTitle').textContent = L.gainTitle;
      $('#gainSub').textContent = L.gainSub;

      $('#metaTitle').textContent = L.metaTitle;
      $('#metaSub').textContent = L.metaSub;
      $('#editTxt').textContent = L.edit;
      $('#addPlTxt').textContent = L.addToPlaylist;
      $('#catTxt').textContent = L.category;

      $('#queueTitle').textContent = L.queueTitle;
      $('#queueSub').textContent = L.queueSub;
      $('#clearQueueTxt').textContent = L.clearQueue;

      // toggles
      themeToggle.textContent = state.settings.theme === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
      langToggle.textContent = state.settings.lang === 'ru' ? 'üá∑üá∫ RU' : 'üá∫üá∏ EN';

      updateNowChip();
      updateVolumeHint();
    }

    // ========= Toast =========
    let toastTimer = null;
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 1800);
    }

    // ========= Modal =========
    function openModal(title, contentNode) {
      modalTitle.textContent = title;
      modalBody.innerHTML = '';
      modalBody.appendChild(contentNode);
      modalOverlay.classList.add('show');
      modalOverlay.setAttribute('aria-hidden','false');
    }
    function closeModal() {
      modalOverlay.classList.remove('show');
      modalOverlay.setAttribute('aria-hidden','true');
    }
    modalCloseBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => {
      if(e.target === modalOverlay) closeModal();
    });

    // ========= Tabs =========
    function setTab(name){
      $$('.tab').forEach(el => el.classList.toggle('active', el.dataset.tab === name));
      $$('.screen').forEach(el => el.classList.toggle('active', el.id === 'screen-' + name));
    }
    $('#tabbar').addEventListener('click', (e) => {
      const tab = e.target.closest('.tab');
      if(!tab) return;
      setTab(tab.dataset.tab);
    });

    // ========= Full player open/close =========
    function openSheet() {
      sheetOverlay.classList.add('show');
      sheetOverlay.setAttribute('aria-hidden','false');
    }
    function closeSheet() {
      sheetOverlay.classList.remove('show');
      sheetOverlay.setAttribute('aria-hidden','true');
      queuePanel.style.display = 'none';
    }
    closeSheetBtn.addEventListener('click', closeSheet);
    sheetOverlay.addEventListener('click', (e) => {
      if(e.target === sheetOverlay) closeSheet();
    });

    // tap / swipe on mini
    let miniTouchStartY = 0;
    miniPlayer.addEventListener('click', (e) => {
      if(e.target.closest('button')) return;
      openSheet();
    });
    miniPlayer.addEventListener('touchstart', (e) => {
      miniTouchStartY = (e.touches && e.touches[0]) ? e.touches[0].clientY : 0;
    }, {passive:true});
    miniPlayer.addEventListener('touchend', (e) => {
      const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : miniTouchStartY;
      if(miniTouchStartY - endY > 22) openSheet();
    });

    // ========= Library import / relink =========
    const allowedExt = new Set(['mp3','m4a','aac','wav','ogg','flac']);
    function isAudioFile(file){
      const name = (file.name || '').toLowerCase();
      const ext = name.includes('.') ? name.split('.').pop() : '';
      // Safari sometimes returns video types; filter by ext OR audio/*
      if(ext && allowedExt.has(ext)) return true;
      if(file.type && file.type.startsWith('audio/')) return true;
      return false;
    }

    function sigOf(file){
      return { name: file.name, size: file.size, mod: file.lastModified || 0 };
    }
    function sigKey(sig){
      return `${sig.name}__${sig.size}__${sig.mod}`;
    }

    function addFilesToLibrary(files){
      const L = t();
      const arr = Array.from(files || []).filter(isAudioFile);
      if(arr.length === 0) return;

      // Build sig map for quick matching existing
      const existingBySig = new Map(state.library.tracks.map(tr => [sigKey(tr.sig), tr]));
      let added = 0;

      for(const f of arr){
        const sig = sigOf(f);
        const key = sigKey(sig);

        if(existingBySig.has(key)){
          // treat as relink for that existing track
          const tr = existingBySig.get(key);
          linkTrackFile(tr.id, f);
          continue;
        }

        const id = uid();
        const base = (f.name || 'Track').replace(/\.[^/.]+$/, '');
        const tr = {
          id,
          sig,
          title: base || 'Track',
          artist: L.unknown,
          coverDataUrl: null,
          category: '',
          fav: false,
          missing: true, // will become false after linking
          addedAt: now()
        };
        state.library.tracks.unshift(tr);
        linkTrackFile(id, f);
        added++;
      }

      persist();
      renderAll();
      showToast(L.toasts.imported(added));
      if(state.library.tracks.some(x=>x.missing)) showToast(L.toasts.needRelink);
    }

    function linkTrackFile(trackId, file){
      const tr = state.library.tracks.find(x => x.id === trackId);
      if(!tr) return;

      // revoke old URL if any
      const old = urlMap.get(trackId);
      if(old){
        try{ URL.revokeObjectURL(old); }catch(e){}
        urlMap.delete(trackId);
      }
      const url = URL.createObjectURL(file);
      urlMap.set(trackId, url);

      tr.missing = false;
    }

    fileInput.addEventListener('change', (e) => {
      addFilesToLibrary(e.target.files);
      fileInput.value = '';
    });

    relinkBtn.addEventListener('click', () => {
      openRelinkModal();
    });

    function openRelinkModal(){
      const L = t();
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div class="muted" style="margin-bottom:10px">${L.modal.relinkBody}</div>
        <div class="row wrap" style="gap:10px">
          <label class="btn primary" style="flex:1; min-width:220px" for="relinkFileInput">üîó ${L.modal.relinkBtn}</label>
          <button class="btn" id="relinkOkBtn">${L.modal.ok}</button>
        </div>
        <input id="relinkFileInput" type="file" accept=".mp3,.m4a,.aac,.wav,.ogg,.flac,audio/*" multiple hidden />
      `;
      openModal(L.modal.relinkTitle, wrap);
      $('#relinkOkBtn', wrap).addEventListener('click', closeModal);
      const relinkInput = $('#relinkFileInput', wrap);
      relinkInput.addEventListener('change', () => {
        const files = Array.from(relinkInput.files || []).filter(isAudioFile);
        const bySig = new Map(files.map(f => [sigKey(sigOf(f)), f]));
        let matched = 0;
        for(const tr of state.library.tracks){
          const f = bySig.get(sigKey(tr.sig));
          if(f){
            linkTrackFile(tr.id, f);
            matched++;
          } else {
            // still missing after relink attempt
            tr.missing = true;
          }
        }
        persist();
        renderAll();
        showToast(L.toasts.relinked(matched));
        relinkInput.value = '';
      });
    }

    // ========= Rendering: Library list =========
    let ui = {
      filter: 'all',
      sort: 'recent',
      search: ''
    };

    searchInput.addEventListener('input', () => {
      ui.search = (searchInput.value || '').trim().toLowerCase();
      renderLibrary();
    });
    sortSelect.addEventListener('change', () => {
      ui.sort = sortSelect.value;
      renderLibrary();
    });
    filterPills.addEventListener('click', (e) => {
      const pill = e.target.closest('.pill');
      if(!pill) return;
      ui.filter = pill.dataset.filter;
      $$('.pill', filterPills).forEach(p => p.classList.toggle('active', p.dataset.filter === ui.filter));
      renderLibrary();
    });

    function makeCoverEl(track){
      const c = document.createElement('div');
      c.className = 'cover';
      if(track.coverDataUrl){
        const img = document.createElement('img');
        img.src = track.coverDataUrl;
        img.alt = '';
        c.appendChild(img);
      } else {
        c.innerHTML = `
          <svg class="note" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M9 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
            <path d="M12 15V5l9-2v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M18 19a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
          </svg>
        `;
      }
      return c;
    }

    function renderLibrary(){
      const L = t();
      const tracks = [...state.library.tracks];

      // filter
      let filtered = tracks.filter(tr => {
        if(ui.filter === 'fav' && !tr.fav) return false;
        if(ui.filter === 'missing' && !tr.missing) return false;
        if(ui.search){
          const hay = `${tr.title} ${tr.artist}`.toLowerCase();
          if(!hay.includes(ui.search)) return false;
        }
        return true;
      });

      // sort
      if(ui.sort === 'recent'){
        filtered.sort((a,b) => (b.addedAt||0) - (a.addedAt||0));
      } else if(ui.sort === 'title'){
        filtered.sort((a,b) => (a.title||'').localeCompare(b.title||''));
      } else if(ui.sort === 'artist'){
        filtered.sort((a,b) => (a.artist||'').localeCompare(b.artist||''));
      }

      trackList.innerHTML = '';

      for(const tr of filtered){
        const card = document.createElement('div');
        card.className = 'track';
        card.dataset.id = tr.id;

        const cover = makeCoverEl(tr);

        const meta = document.createElement('div');
        meta.className = 'tmeta';
        meta.innerHTML = `
          <div class="tname">${escapeHtml(tr.title || 'Track')}</div>
          <div class="tauthor">${escapeHtml(tr.artist || L.unknown)}</div>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            ${tr.missing ? `<span class="badge missing">‚ö†Ô∏è ${L.missingBadge}</span>` : ``}
            ${tr.fav ? `<span class="badge fav">‚≠ê ${L.favBadge}</span>` : ``}
            ${tr.category ? `<span class="badge">üè∑Ô∏è ${escapeHtml(tr.category)}</span>` : ``}
          </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'actions';
        const fav = document.createElement('button');
        fav.className = 'btn icon';
        fav.textContent = tr.fav ? '‚≠ê' : '‚òÜ';
        fav.setAttribute('aria-label','Favorite');
        fav.addEventListener('click', (e) => {
          e.stopPropagation();
          tr.fav = !tr.fav;
          persist();
          renderLibrary();
          renderPlayerUI();
        });

        const more = document.createElement('button');
        more.className = 'btn icon';
        more.textContent = '‚ãØ';
        more.setAttribute('aria-label','More');
        more.addEventListener('click', (e) => {
          e.stopPropagation();
          openTrackActionsModal(tr.id);
        });

        actions.appendChild(fav);
        actions.appendChild(more);

        card.appendChild(cover);
        card.appendChild(meta);
        card.appendChild(actions);

        card.addEventListener('click', () => {
          // tap track -> play + add to queue
          enqueueAndPlay(tr.id);
        });

        trackList.appendChild(card);
      }

      updateNowChip();
    }

    // ========= Playlists rendering =========
    let playlistView = { mode:'list', currentId:null };

    function renderPlaylists(){
      const L = t();
      playlistViewRoot.innerHTML = '';

      if(playlistView.mode === 'list'){
        const listWrap = document.createElement('div');

        if(state.playlists.order.length === 0){
          const empty = document.createElement('div');
          empty.className = 'hint';
          empty.textContent = L.playlistEmpty;
          listWrap.appendChild(empty);
        } else {
          for(const pid of state.playlists.order){
            const pl = state.playlists.byId[pid];
            if(!pl) continue;

            const row = document.createElement('div');
            row.className = 'track';
            row.style.alignItems = 'flex-start';

            const cover = document.createElement('div');
            cover.className = 'cover';
            cover.innerHTML = 'üéµ';

            const meta = document.createElement('div');
            meta.className = 'tmeta';
            meta.innerHTML = `
              <div class="tname">${escapeHtml(pl.name || 'Playlist')}</div>
              <div class="tauthor">${pl.trackIds.length} track(s)</div>
            `;

            const actions = document.createElement('div');
            actions.className = 'actions';
            const openBtn = document.createElement('button');
            openBtn.className = 'btn small';
            openBtn.textContent = L.openPlaylist;
            openBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              playlistView.mode = 'detail';
              playlistView.currentId = pl.id;
              renderPlaylists();
            });
            const moreBtn = document.createElement('button');
            moreBtn.className = 'btn icon';
            moreBtn.textContent = '‚ãØ';
            moreBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              openPlaylistActionsModal(pl.id);
            });
            actions.appendChild(openBtn);
            actions.appendChild(moreBtn);

            row.appendChild(cover);
            row.appendChild(meta);
            row.appendChild(actions);
            row.addEventListener('click', () => {
              playlistView.mode = 'detail';
              playlistView.currentId = pl.id;
              renderPlaylists();
            });

            listWrap.appendChild(row);
          }
        }

        playlistViewRoot.appendChild(listWrap);
      } else {
        const pid = playlistView.currentId;
        const pl = state.playlists.byId[pid];
        if(!pl){
          playlistView.mode='list'; playlistView.currentId=null;
          return renderPlaylists();
        }

        const head = document.createElement('div');
        head.className = 'row wrap';
        head.style.gap = '10px';
        head.innerHTML = `
          <button class="btn small" id="plBackBtn">${L.modal.back}</button>
          <div style="flex:1; min-width:200px">
            <div class="title">${escapeHtml(pl.name)}</div>
            <div class="sub">${pl.trackIds.length} track(s)</div>
          </div>
          <button class="btn small" id="plMoreBtn">‚ãØ</button>
        `;
        playlistViewRoot.appendChild(head);

        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.style.marginTop = '10px';
        hint.textContent = L.addFromLibrary;
        playlistViewRoot.appendChild(hint);

        const list = document.createElement('div');
        list.className = 'tracks';
        list.style.marginTop = '10px';

        if(pl.trackIds.length === 0){
          const empty = document.createElement('div');
          empty.className = 'hint';
          empty.textContent = L.playlistTracksEmpty;
          list.appendChild(empty);
        } else {
          for(let i=0;i<pl.trackIds.length;i++){
            const tid = pl.trackIds[i];
            const tr = state.library.tracks.find(x=>x.id===tid);
            if(!tr) continue;

            const row = document.createElement('div');
            row.className = 'track';
            row.style.alignItems = 'flex-start';

            const cover = makeCoverEl(tr);
            const meta = document.createElement('div');
            meta.className = 'tmeta';
            meta.innerHTML = `
              <div class="tname">${escapeHtml(tr.title)}</div>
              <div class="tauthor">${escapeHtml(tr.artist || L.unknown)}</div>
              <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                ${tr.missing ? `<span class="badge missing">‚ö†Ô∏è ${L.missingBadge}</span>` : ``}
                ${tr.fav ? `<span class="badge fav">‚≠ê ${L.favBadge}</span>` : ``}
              </div>
            `;

            const actions = document.createElement('div');
            actions.className = 'actions';

            const up = document.createElement('button');
            up.className = 'btn icon';
            up.textContent = '‚Üë';
            up.disabled = (i===0);
            up.addEventListener('click', (e) => {
              e.stopPropagation();
              if(i===0) return;
              const tmp = pl.trackIds[i-1];
              pl.trackIds[i-1] = pl.trackIds[i];
              pl.trackIds[i] = tmp;
              persist();
              renderPlaylists();
            });

            const down = document.createElement('button');
            down.className = 'btn icon';
            down.textContent = '‚Üì';
            down.disabled = (i===pl.trackIds.length-1);
            down.addEventListener('click', (e) => {
              e.stopPropagation();
              if(i>=pl.trackIds.length-1) return;
              const tmp = pl.trackIds[i+1];
              pl.trackIds[i+1] = pl.trackIds[i];
              pl.trackIds[i] = tmp;
              persist();
              renderPlaylists();
            });

            const play = document.createElement('button');
            play.className = 'btn icon';
            play.textContent = '‚ñ∂Ô∏è';
            play.addEventListener('click', (e) => {
              e.stopPropagation();
              enqueueAndPlay(tr.id);
              openSheet();
            });

            const remove = document.createElement('button');
            remove.className = 'btn icon';
            remove.textContent = '‚àí';
            remove.addEventListener('click', (e) => {
              e.stopPropagation();
              pl.trackIds = pl.trackIds.filter(x=>x!==tr.id);
              persist();
              renderPlaylists();
            });

            actions.appendChild(up);
            actions.appendChild(down);
            actions.appendChild(play);
            actions.appendChild(remove);

            row.appendChild(cover);
            row.appendChild(meta);
            row.appendChild(actions);
            row.addEventListener('click', () => enqueueAndPlay(tr.id));

            list.appendChild(row);
          }
        }

        playlistViewRoot.appendChild(list);

        $('#plBackBtn').addEventListener('click', () => {
          playlistView.mode='list';
          playlistView.currentId=null;
          renderPlaylists();
        });
        $('#plMoreBtn').addEventListener('click', () => openPlaylistActionsModal(pl.id));
      }
    }

    // ========= Player / Queue =========
    function ensureQueueHas(trackId){
      if(!state.queue.ids.includes(trackId)){
        state.queue.ids.push(trackId);
      }
    }

    function enqueueAndPlay(trackId){
      const L = t();
      const tr = state.library.tracks.find(x=>x.id===trackId);
      if(!tr) return;

      ensureQueueHas(trackId);

      // move index to this track
      state.queue.index = state.queue.ids.indexOf(trackId);

      persist();
      playCurrent().catch(()=>{});
      openSheet();
    }

    function getCurrentTrack(){
      const id = state.queue.ids[state.queue.index];
      if(!id) return null;
      return state.library.tracks.find(x=>x.id===id) || null;
    }

    function canPlayTrack(tr){
      if(!tr) return false;
      if(tr.missing) return false;
      const u = urlMap.get(tr.id);
      return !!u;
    }

    async function playCurrent(){
      const L = t();
      const tr = getCurrentTrack();
      if(!tr) return;

      if(!canPlayTrack(tr)){
        showToast(L.toasts.cannotPlayMissing);
        renderPlayerUI();
        return;
      }

      // WebAudio: try to init/resume inside this user gesture call chain
      ensureWebAudio();
      await resumeAudioContextIfNeeded();

      audio.src = urlMap.get(tr.id);
      audio.muted = false; // we control mute via gain for honesty; audio.muted also set for "always works"
      audio.currentTime = clamp(audio.currentTime || 0, 0, audio.duration || 0);

      // update last played
      state.settings.lastPlayedId = tr.id;
      persist();

      try{
        await audio.play();
      }catch(e){
        // iOS may block play without gesture; show hint
        showToast(isIOS ? 'Tap Play to start (iOS gesture required)' : 'Tap Play');
      }
      renderPlayerUI();
    }

    function pause(){
      audio.pause();
      renderPlayerUI();
    }

    function togglePlay(){
      if(audio.paused) return playCurrent();
      pause();
    }

    function next(){
      const L = t();
      if(state.queue.ids.length === 0) return;

      if(state.settings.shuffle){
        // random next, but avoid repeating same if possible
        if(state.queue.ids.length === 1){
          state.queue.index = 0;
        } else {
          let tries = 8;
          let nextIdx = state.queue.index;
          while(tries-- > 0 && nextIdx === state.queue.index){
            nextIdx = Math.floor(Math.random() * state.queue.ids.length);
          }
          state.queue.index = nextIdx;
        }
      } else {
        state.queue.index++;
        if(state.queue.index >= state.queue.ids.length){
          if(state.settings.repeat === 'all'){
            state.queue.index = 0;
          } else {
            state.queue.index = state.queue.ids.length - 1;
            pause();
            renderPlayerUI();
            return;
          }
        }
      }
      persist();
      playCurrent().catch(()=>{});
    }

    function prev(){
      if(state.queue.ids.length === 0) return;
      // if more than 3s -> restart track
      if(audio.currentTime > 3){
        audio.currentTime = 0;
        return;
      }
      state.queue.index--;
      if(state.queue.index < 0){
        state.queue.index = (state.settings.repeat === 'all') ? state.queue.ids.length - 1 : 0;
      }
      persist();
      playCurrent().catch(()=>{});
    }

    function setRepeat(){
      // off -> all -> one -> off
      const cur = state.settings.repeat;
      state.settings.repeat = (cur === 'off') ? 'all' : (cur === 'all') ? 'one' : 'off';
      persist();
      renderPlayerUI();
    }

    function setShuffle(){
      state.settings.shuffle = !state.settings.shuffle;
      persist();
      renderPlayerUI();
    }

    // end handling
    audio.addEventListener('ended', () => {
      if(state.settings.repeat === 'one'){
        audio.currentTime = 0;
        audio.play().catch(()=>{});
        return;
      }
      next();
    });

    // progress updates
    let seeking = false;
    audio.addEventListener('timeupdate', () => {
      if(seeking) return;
      const dur = audio.duration || 0;
      const cur = audio.currentTime || 0;
      if(dur > 0){
        seek.value = String(Math.round((cur / dur) * 1000));
      } else {
        seek.value = '0';
      }
      tCur.textContent = fmtTime(cur);
      tDur.textContent = fmtTime(dur);
    });
    audio.addEventListener('loadedmetadata', () => {
      const dur = audio.duration || 0;
      tDur.textContent = fmtTime(dur);
    });

    seek.addEventListener('input', () => {
      seeking = true;
      const dur = audio.duration || 0;
      const v = Number(seek.value) / 1000;
      const pos = dur * v;
      tCur.textContent = fmtTime(pos);
    });
    seek.addEventListener('change', () => {
      const dur = audio.duration || 0;
      const v = Number(seek.value) / 1000;
      audio.currentTime = dur * v;
      seeking = false;
    });

    // transport buttons
    playBtn.addEventListener('click', () => togglePlay());
    miniPlayBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlay(); });
    nextBtn.addEventListener('click', () => next());
    miniNextBtn.addEventListener('click', (e) => { e.stopPropagation(); next(); });
    prevBtn.addEventListener('click', () => prev());

    shuffleBtn.addEventListener('click', () => setShuffle());
    repeatBtn.addEventListener('click', () => setRepeat());

    favBtn.addEventListener('click', () => {
      const tr = getCurrentTrack();
      if(!tr) return;
      tr.fav = !tr.fav;
      persist();
      renderAll();
    });

    queueToggleBtn.addEventListener('click', () => {
      const showing = queuePanel.style.display !== 'none';
      queuePanel.style.display = showing ? 'none' : 'block';
      renderQueue();
    });

    clearQueueBtn.addEventListener('click', () => {
      state.queue.ids = [];
      state.queue.index = -1;
      persist();
      renderAll();
    });

    // queue reorder + jump
    function renderQueue(){
      const L = t();
      queueList.innerHTML = '';
      const ids = state.queue.ids;

      if(ids.length === 0){
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.textContent = '‚Äî';
        queueList.appendChild(empty);
        return;
      }

      ids.forEach((id, i) => {
        const tr = state.library.tracks.find(x=>x.id===id);
        if(!tr) return;

        const item = document.createElement('div');
        item.className = 'queueItem';
        item.style.borderColor = (i === state.queue.index) ? 'rgba(110,231,255,.35)' : 'var(--line)';
        item.style.background = (i === state.queue.index) ? 'rgba(110,231,255,.10)' : 'rgba(255,255,255,.03)';

        const meta = document.createElement('div');
        meta.className = 'qmeta';
        meta.innerHTML = `
          <div class="qname">${escapeHtml(tr.title)}</div>
          <div class="qauth">${escapeHtml(tr.artist || L.unknown)}${tr.missing ? ' ‚Ä¢ ‚ö†Ô∏è '+L.missingBadge : ''}</div>
        `;

        const btns = document.createElement('div');
        btns.className = 'qbtns';

        const up = document.createElement('button');
        up.className = 'btn icon';
        up.textContent = '‚Üë';
        up.disabled = (i===0);
        up.addEventListener('click', () => {
          if(i===0) return;
          const tmp = ids[i-1];
          ids[i-1] = ids[i];
          ids[i] = tmp;
          if(state.queue.index === i) state.queue.index = i-1;
          else if(state.queue.index === i-1) state.queue.index = i;
          persist();
          renderQueue();
        });

        const down = document.createElement('button');
        down.className = 'btn icon';
        down.textContent = '‚Üì';
        down.disabled = (i===ids.length-1);
        down.addEventListener('click', () => {
          if(i>=ids.length-1) return;
          const tmp = ids[i+1];
          ids[i+1] = ids[i];
          ids[i] = tmp;
          if(state.queue.index === i) state.queue.index = i+1;
          else if(state.queue.index === i+1) state.queue.index = i;
          persist();
          renderQueue();
        });

        const play = document.createElement('button');
        play.className = 'btn icon';
        play.textContent = '‚ñ∂Ô∏è';
        play.addEventListener('click', () => {
          state.queue.index = i;
          persist();
          playCurrent().catch(()=>{});
          renderAll();
        });

        const del = document.createElement('button');
        del.className = 'btn icon';
        del.textContent = '‚úñÔ∏è';
        del.addEventListener('click', () => {
          const wasCurrent = (i === state.queue.index);
          ids.splice(i,1);
          if(ids.length === 0){
            state.queue.index = -1;
            audio.pause();
          } else {
            if(wasCurrent){
              state.queue.index = clamp(i, 0, ids.length-1);
              playCurrent().catch(()=>{});
            } else if(i < state.queue.index){
              state.queue.index--;
            }
          }
          persist();
          renderAll();
        });

        btns.appendChild(up);
        btns.appendChild(down);
        btns.appendChild(play);
        btns.appendChild(del);

        item.appendChild(meta);
        item.appendChild(btns);

        item.addEventListener('click', () => {
          state.queue.index = i;
          persist();
          playCurrent().catch(()=>{});
          renderAll();
        });

        queueList.appendChild(item);
      });
    }

    // ========= Volume / Gain / Mute =========
    function updateVolumeHint(){
      const L = t();
      const parts = [];
      if(isIOS){
        parts.push('üì± ' + (state.settings.lang==='ru'
          ? '–ù–∞ iPhone —Å–∏—Å—Ç–µ–º–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å –æ–±—ã—á–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.'
          : 'On iPhone, system volume is usually controlled by hardware buttons.'));
      }
      parts.push('üéöÔ∏è ' + (state.settings.lang==='ru'
        ? '–ü–æ–ª–∑—É–Ω–æ–∫ –∑–¥–µ—Å—å ‚Äî —ç—Ç–æ Gain (—É—Å–∏–ª–µ–Ω–∏–µ) —á–µ—Ä–µ–∑ WebAudio. –≠—Ç–æ –ù–ï ‚Äú—Å–∏—Å—Ç–µ–º–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å‚Äù.'
        : 'The slider here is Gain (preamp) via WebAudio. It is NOT system volume.'));
      parts.push('üîá ' + (state.settings.lang==='ru'
        ? 'Mute/Unmute —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞.'
        : 'Mute/Unmute always works.'));
      volumeHint.innerHTML = parts.join('<br/>');
    }

    function applyGain(){
      // Always keep audio.volume at 1 for honesty (system volume is external on iOS)
      audio.volume = 1;
      // Mute must always work -> use audio.muted too
      audio.muted = !!state.settings.muted;

      const g = state.settings.muted ? 0 : state.settings.gain;
      if(ensureWebAudio() && gainNode){
        gainNode.gain.value = g;
      }
      updateMuteUI();
    }

    function updateMuteUI(){
      const L = t();
      const label = state.settings.muted ? L.unmute : L.mute;
      muteBtn.innerHTML = (state.settings.muted ? 'üîà ' : 'üîá ') + `<span id="muteTxt">${label}</span>`;
    }

    muteBtn.addEventListener('click', async () => {
      // user gesture: can resume ctx
      ensureWebAudio();
      await resumeAudioContextIfNeeded();

      state.settings.muted = !state.settings.muted;
      persist();
      applyGain();
      renderPlayerUI();
    });

    gain.addEventListener('input', async () => {
      ensureWebAudio();
      await resumeAudioContextIfNeeded();

      const v = Number(gain.value);
      // 0..200% => 0..2.0
      state.settings.gain = clamp(v / 100, 0, 2);
      persist();
      applyGain();
      renderPlayerUI();
    });

    // ========= Track actions modal =========
    function openTrackActionsModal(trackId){
      const L = t();
      const tr = state.library.tracks.find(x=>x.id===trackId);
      if(!tr) return;

      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div class="muted" style="margin-bottom:10px">
          <b>${escapeHtml(tr.title)}</b><br/>
          ${escapeHtml(tr.artist || L.unknown)}
        </div>
        <div class="grid2">
          <button class="btn" id="actPlay">‚ñ∂Ô∏è ${L.modal.open}</button>
          <button class="btn" id="actEdit">‚úèÔ∏è ${L.modal.editInfo}</button>
          <button class="btn" id="actAdd">‚ûï ${L.addToPlaylist}</button>
          <button class="btn" id="actCat">üè∑Ô∏è ${L.category}</button>
          <button class="btn" id="actFav">${tr.fav ? '‚≠ê' : '‚òÜ'} ${L.favorite}</button>
          <button class="btn danger" id="actRemove">üóëÔ∏è ${L.modal.remove}</button>
        </div>
        <div class="muted" style="margin-top:10px">
          ${tr.missing ? '‚ö†Ô∏è '+L.missingBadge+' ‚Äî '+(L.lang==='ru'?'–Ω—É–∂–µ–Ω Relink.':'Relink required.') : ''}
        </div>
      `;
      openModal('Track', wrap);

      $('#actPlay', wrap).addEventListener('click', () => { closeModal(); enqueueAndPlay(trackId); openSheet(); });
      $('#actEdit', wrap).addEventListener('click', () => { closeModal(); openEditInfoModal(trackId); });
      $('#actAdd', wrap).addEventListener('click', () => { closeModal(); openAddToPlaylistModal(trackId); });
      $('#actCat', wrap).addEventListener('click', () => { closeModal(); openAssignCategoryModal(trackId); });
      $('#actFav', wrap).addEventListener('click', () => {
        tr.fav = !tr.fav;
        persist();
        renderAll();
        closeModal();
      });
      $('#actRemove', wrap).addEventListener('click', () => {
        removeTrack(trackId);
        persist();
        renderAll();
        closeModal();
      });
    }

    function removeTrack(trackId){
      // remove from playlists
      for(const pid of state.playlists.order){
        const pl = state.playlists.byId[pid];
        if(pl) pl.trackIds = pl.trackIds.filter(x=>x!==trackId);
      }
      // remove from queue
      const idx = state.queue.ids.indexOf(trackId);
      if(idx >= 0){
        state.queue.ids.splice(idx,1);
        if(state.queue.index === idx){
          audio.pause();
          state.queue.index = clamp(idx, 0, state.queue.ids.length-1);
        } else if(idx < state.queue.index){
          state.queue.index--;
        }
      }
      // revoke url
      const old = urlMap.get(trackId);
      if(old){ try{ URL.revokeObjectURL(old); }catch(e){} urlMap.delete(trackId); }
      // remove from library
      state.library.tracks = state.library.tracks.filter(x=>x.id!==trackId);
      if(state.settings.lastPlayedId === trackId) state.settings.lastPlayedId = null;
    }

    // ========= Edit info modal =========
    editInfoBtn.addEventListener('click', () => {
      const tr = getCurrentTrack();
      if(!tr) return;
      openEditInfoModal(tr.id);
    });

    function openEditInfoModal(trackId){
      const L = t();
      const tr = state.library.tracks.find(x=>x.id===trackId);
      if(!tr) return;

      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div class="muted" style="margin-bottom:10px">${L.metaSub}</div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div>
            <div class="muted">${L.modal.title}</div>
            <input class="input" id="mTitle" value="${escapeAttr(tr.title||'')}" />
          </div>
          <div>
            <div class="muted">${L.modal.artist}</div>
            <input class="input" id="mArtist" value="${escapeAttr(tr.artist||L.unknown)}" />
          </div>
          <div>
            <div class="muted">${L.modal.cover}</div>
            <div class="row wrap" style="gap:10px">
              <label class="btn" for="mCover">${L.modal.setCover}</label>
              <input id="mCover" type="file" accept="image/*" hidden />
              <button class="btn" id="mClearCover">${L.modal.clearCover}</button>
            </div>
            <div class="muted" style="margin-top:8px">${tr.coverDataUrl ? '‚úÖ cover set' : '‚Äî'}</div>
          </div>
          <div class="row wrap" style="gap:10px; margin-top:6px">
            <button class="btn primary" id="mSave">${L.modal.save}</button>
            <button class="btn" id="mCancel">${L.modal.cancel}</button>
          </div>
        </div>
      `;
      openModal(L.modal.editInfo, wrap);

      $('#mCancel', wrap).addEventListener('click', closeModal);
      $('#mSave', wrap).addEventListener('click', () => {
        tr.title = ($('#mTitle', wrap).value || '').trim() || tr.title;
        tr.artist = ($('#mArtist', wrap).value || '').trim() || L.unknown;
        persist();
        renderAll();
        showToast(L.toasts.updated);
        closeModal();
      });

      const coverInput = $('#mCover', wrap);
      coverInput.addEventListener('change', () => {
        const f = (coverInput.files && coverInput.files[0]) ? coverInput.files[0] : null;
        if(!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          tr.coverDataUrl = String(reader.result || '');
          persist();
          renderAll();
          showToast(L.toasts.updated);
        };
        reader.readAsDataURL(f);
        coverInput.value = '';
      });

      $('#mClearCover', wrap).addEventListener('click', () => {
        tr.coverDataUrl = null;
        persist();
        renderAll();
        showToast(L.toasts.updated);
        closeModal();
      });
    }

    // ========= Add to playlist =========
    addToPlaylistBtn.addEventListener('click', () => {
      const tr = getCurrentTrack();
      if(!tr) return;
      openAddToPlaylistModal(tr.id);
    });

    function openAddToPlaylistModal(trackId){
      const L = t();
      const tr = state.library.tracks.find(x=>x.id===trackId);
      if(!tr) return;

      const wrap = document.createElement('div');
      const list = document.createElement('div');
      list.style.display = 'flex';
      list.style.flexDirection = 'column';
      list.style.gap = '10px';

      if(state.playlists.order.length === 0){
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = (state.settings.lang==='ru') ? '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –ø–ª–µ–π–ª–∏—Å—Ç –≤ –≤–∫–ª–∞–¥–∫–µ Playlists.' : 'Create a playlist first in Playlists tab.';
        list.appendChild(empty);
      } else {
        for(const pid of state.playlists.order){
          const pl = state.playlists.byId[pid];
          if(!pl) continue;
          const has = pl.trackIds.includes(trackId);

          const row = document.createElement('div');
          row.className = 'row wrap';
          row.style.alignItems = 'center';
          row.style.gap = '10px';

          const left = document.createElement('div');
          left.style.flex = '1';
          left.innerHTML = `<div class="title" style="font-size:13px">${escapeHtml(pl.name)}</div>
                            <div class="sub">${pl.trackIds.length} track(s)</div>`;
          const btn = document.createElement('button');
          btn.className = 'btn small ' + (has ? '' : 'primary');
          btn.textContent = has ? ('‚àí ' + L.modal.remove) : ('+ ' + L.modal.add);
          btn.addEventListener('click', () => {
            if(has){
              pl.trackIds = pl.trackIds.filter(x=>x!==trackId);
            } else {
              pl.trackIds.push(trackId);
            }
            persist();
            renderAll();
            closeModal();
          });

          row.appendChild(left);
          row.appendChild(btn);
          list.appendChild(row);
        }
      }

      wrap.appendChild(list);

      const footer = document.createElement('div');
      footer.style.marginTop = '12px';
      footer.innerHTML = `<button class="btn" id="plClose">${L.modal.cancel}</button>`;
      wrap.appendChild(footer);

      openModal(L.modal.pickPlaylist, wrap);
      $('#plClose', wrap).addEventListener('click', closeModal);
    }

    // ========= Assign category =========
    assignCatBtn.addEventListener('click', () => {
      const tr = getCurrentTrack();
      if(!tr) return;
      openAssignCategoryModal(tr.id);
    });

    function openAssignCategoryModal(trackId){
      const L = t();
      const tr = state.library.tracks.find(x=>x.id===trackId);
      if(!tr) return;

      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div class="muted" style="margin-bottom:10px">${L.modal.assignCategory}</div>
        <div style="display:flex; flex-direction:column; gap:10px">
          <input class="input" id="catIn" placeholder="${L.modal.categoryName}" value="${escapeAttr(tr.category||'')}" />
          <div class="row wrap" style="gap:10px">
            <button class="btn primary" id="catSave">${L.modal.save}</button>
            <button class="btn" id="catCancel">${L.modal.cancel}</button>
          </div>
        </div>
      `;
      openModal(L.modal.assignCategory, wrap);

      $('#catCancel', wrap).addEventListener('click', closeModal);
      $('#catSave', wrap).addEventListener('click', () => {
        tr.category = ($('#catIn', wrap).value || '').trim();
        persist();
        renderAll();
        showToast(L.toasts.updated);
        closeModal();
      });
    }

    // ========= Playlist create & actions =========
    $('#createPlaylistBtn').addEventListener('click', () => openCreatePlaylistModal());

    function openCreatePlaylistModal(){
      const L = t();
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:10px">
          <div class="muted">${L.modal.playlistName}</div>
          <input class="input" id="plName" placeholder="${L.modal.playlistName}" />
          <div class="row wrap" style="gap:10px">
            <button class="btn primary" id="plCreate">${L.modal.create}</button>
            <button class="btn" id="plCancel">${L.modal.cancel}</button>
          </div>
        </div>
      `;
      openModal(L.modal.createPlaylist, wrap);

      $('#plCancel', wrap).addEventListener('click', closeModal);
      $('#plCreate', wrap).addEventListener('click', () => {
        const name = ($('#plName', wrap).value || '').trim();
        if(!name) return;
        const id = uid();
        state.playlists.byId[id] = { id, name, trackIds: [] };
        state.playlists.order.unshift(id);
        persist();
        renderPlaylists();
        showToast(L.toasts.createdPlaylist);
        closeModal();
      });
    }

    function openPlaylistActionsModal(pid){
      const L = t();
      const pl = state.playlists.byId[pid];
      if(!pl) return;

      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div class="muted" style="margin-bottom:10px"><b>${escapeHtml(pl.name)}</b></div>
        <div style="display:flex; flex-direction:column; gap:10px">
          <button class="btn" id="plRename">‚úèÔ∏è ${L.modal.rename}</button>
          <button class="btn danger" id="plDelete">üóëÔ∏è ${L.modal.delete}</button>
          <button class="btn" id="plClose">${L.modal.cancel}</button>
        </div>
      `;
      openModal('Playlist', wrap);

      $('#plClose', wrap).addEventListener('click', closeModal);
      $('#plRename', wrap).addEventListener('click', () => {
        closeModal();
        openRenamePlaylistModal(pid);
      });
      $('#plDelete', wrap).addEventListener('click', () => {
        deletePlaylist(pid);
        persist();
        renderPlaylists();
        closeModal();
      });
    }

    function openRenamePlaylistModal(pid){
      const L = t();
      const pl = state.playlists.byId[pid];
      if(!pl) return;

      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:10px">
          <div class="muted">${L.modal.playlistName}</div>
          <input class="input" id="plName" value="${escapeAttr(pl.name)}" />
          <div class="row wrap" style="gap:10px">
            <button class="btn primary" id="plSave">${L.modal.save}</button>
            <button class="btn" id="plCancel">${L.modal.cancel}</button>
          </div>
        </div>
      `;
      openModal(L.modal.rename, wrap);

      $('#plCancel', wrap).addEventListener('click', closeModal);
      $('#plSave', wrap).addEventListener('click', () => {
        const name = ($('#plName', wrap).value || '').trim();
        if(!name) return;
        pl.name = name;
        persist();
        renderPlaylists();
        closeModal();
      });
    }

    function deletePlaylist(pid){
      delete state.playlists.byId[pid];
      state.playlists.order = state.playlists.order.filter(x=>x!==pid);
      if(playlistView.currentId === pid){
        playlistView.mode='list';
        playlistView.currentId=null;
      }
    }

    // ========= Settings =========
    themeToggle.addEventListener('click', () => {
      state.settings.theme = (state.settings.theme === 'dark') ? 'light' : 'dark';
      persist();
      applyTheme();
      applyTexts();
    });

    langToggle.addEventListener('click', () => {
      state.settings.lang = (state.settings.lang === 'ru') ? 'en' : 'ru';
      persist();
      applyTexts();
      renderAll();
    });

    clearDataBtn.addEventListener('click', () => {
      const L = t();
      // clear all + revoke urls
      revokeAllUrls();
      state = {
        settings: {
          theme: state.settings.theme,
          lang: state.settings.lang,
          lastPlayedId: null,
          shuffle: false,
          repeat: 'off',
          muted: false,
          gain: 1.0
        },
        library: { tracks: [] },
        playlists: { byId: {}, order: [] },
        queue: { ids: [], index: -1 }
      };
      persist();
      renderAll();
      showToast(L.toasts.cleared);
    });

    function applyTheme(){
      appEl.setAttribute('data-theme', state.settings.theme);
      // theme-color
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute('content', state.settings.theme === 'dark' ? '#0b0b0f' : '#f6f6fb');
    }

    // ========= Mini/Full UI render =========
    function renderPlayerUI(){
      const L = t();
      const tr = getCurrentTrack();

      // mini visibility
      miniPlayer.classList.toggle('hidden', !tr);

      if(!tr){
        miniTitle.textContent = '‚Äî';
        miniArtist.textContent = '‚Äî';
        bigTitle.textContent = '‚Äî';
        bigArtist.textContent = '‚Äî';
        playBtn.textContent = '‚ñ∂Ô∏è';
        miniPlayBtn.textContent = '‚ñ∂Ô∏è';
        return;
      }

      miniTitle.textContent = tr.title || 'Track';
      miniArtist.textContent = tr.artist || L.unknown;

      bigTitle.textContent = tr.title || 'Track';
      bigArtist.textContent = tr.artist || L.unknown;

      // cover
      setCoverNode(miniCover, tr.coverDataUrl, true);
      setCoverNode(bigCover, tr.coverDataUrl, false);

      // states
      shuffleState.textContent = state.settings.shuffle ? 'On' : 'Off';
      repeatState.textContent = (state.settings.repeat === 'off') ? 'Off' : (state.settings.repeat === 'all') ? 'All' : 'One';

      shuffleBtn.classList.toggle('primary', state.settings.shuffle);
      repeatBtn.classList.toggle('primary', state.settings.repeat !== 'off');

      favBtn.classList.toggle('primary', !!tr.fav);
      favBtn.innerHTML = (tr.fav ? '‚≠ê' : '‚òÜ') + ' <span id="favTxt">'+L.favorite+'</span>';

      // play buttons
      const playing = !audio.paused && audio.currentSrc;
      playBtn.textContent = playing ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
      miniPlayBtn.textContent = playing ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';

      // missing cues
      const canPlay = canPlayTrack(tr);
      $('#sheetChip').textContent = canPlay ? 'Player' : 'Missing';

      updateMuteUI();
      gain.value = String(Math.round(clamp(state.settings.gain,0,2) * 100));
      applyGain();

      if(queuePanel.style.display !== 'none') renderQueue();
    }

    function setCoverNode(node, dataUrl, small){
      node.innerHTML = '';
      node.classList.add('cover');
      if(dataUrl){
        const img = document.createElement('img');
        img.src = dataUrl;
        img.alt = '';
        node.appendChild(img);
      } else {
        node.innerHTML = `
          <svg class="note" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="${small ? 'width:22px;height:22px' : 'width:46px;height:46px'};opacity:.9">
            <path d="M9 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
            <path d="M12 15V5l9-2v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M18 19a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="2"/>
          </svg>
        `;
      }
    }

    function updateNowChip(){
      const L = t();
      nowChip.textContent = L.nowChip(state.library.tracks.length);
    }

    // ========= Persist =========
    function persist(){
      // Never store objectURLs. Tracks keep "missing" as true unless relinked in this session.
      // On reload: all tracks become missing.
      const snapshot = structuredCloneSafe(state);
      // force missing on save? NO (keep session info), but on load we will set missing=true.
      save(snapshot);
    }

    function structuredCloneSafe(obj){
      try { return structuredClone(obj); }
      catch(e) { return JSON.parse(JSON.stringify(obj)); }
    }

    // ========= Initial load =========
    function hydrate(){
      const saved = load();
      if(saved){
        // Merge defaults to handle older versions
        state.settings = Object.assign({}, state.settings, saved.settings || {});
        state.library = Object.assign({}, state.library, saved.library || {});
        state.playlists = Object.assign({}, state.playlists, saved.playlists || {});
        state.queue = Object.assign({}, state.queue, saved.queue || {});

        // After reload, all file links are gone -> mark tracks missing
        if(state.library && Array.isArray(state.library.tracks)){
          state.library.tracks.forEach(tr => { tr.missing = true; });
        } else {
          state.library = { tracks: [] };
        }
        // queue might reference tracks that no longer exist
        state.queue.ids = (state.queue.ids || []).filter(id => state.library.tracks.some(tr=>tr.id===id));
        if(state.queue.ids.length === 0) state.queue.index = -1;
        state.queue.index = clamp(state.queue.index ?? -1, -1, state.queue.ids.length-1);
      }

      applyTheme();
      applyTexts();
      renderAll();

      // If had last played, put it into queue top so mini-player appears (still missing until relink)
      if(state.settings.lastPlayedId && state.library.tracks.some(tr=>tr.id===state.settings.lastPlayedId)){
        if(!state.queue.ids.includes(state.settings.lastPlayedId)){
          state.queue.ids.unshift(state.settings.lastPlayedId);
        }
        state.queue.index = state.queue.ids.indexOf(state.settings.lastPlayedId);
      }

      renderAll();

      if(state.library.tracks.some(x=>x.missing) && state.library.tracks.length > 0){
        showToast(t().toasts.needRelink);
      }
    }

    function renderAll(){
      renderLibrary();
      renderPlaylists();
      renderPlayerUI();
      updateNowChip();
    }

    // ========= Escapes =========
    function escapeHtml(s){
      s = String(s ?? '');
      return s.replace(/[&<>"']/g, (c) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
    function escapeAttr(s){
      return escapeHtml(s).replace(/"/g,'&quot;');
    }

    // ========= Track-level actions buttons =========
    function syncCurrentTrackIfNeeded(){
      const tr = getCurrentTrack();
      if(!tr) return null;
      return tr;
    }

    // Assign current track actions
    function ensureCurrentPlayableOrWarn(){
      const L = t();
      const tr = getCurrentTrack();
      if(!tr) return false;
      if(!canPlayTrack(tr)){
        showToast(L.toasts.cannotPlayMissing);
        return false;
      }
      return true;
    }

    // Open actions from full player (current track)
    bigCover.addEventListener('click', () => {
      const tr = getCurrentTrack();
      if(!tr) return;
      // quick toggle queue panel
      queuePanel.style.display = (queuePanel.style.display === 'none') ? 'block' : 'none';
      renderQueue();
    });

    // Clicking big title opens actions
    bigTitle.addEventListener('click', () => {
      const tr = getCurrentTrack();
      if(!tr) return;
      openTrackActionsModal(tr.id);
    });

    // ========= Relink shortcut: if play pressed but missing =========
    playBtn.addEventListener('click', () => {
      const tr = getCurrentTrack();
      if(tr && tr.missing){
        // show relink modal but still let them try play (it will toast)
        openRelinkModal();
      }
    });

    // ========= Prevent ‚Äúfake volume‚Äù =========
    function initVolumeUI(){
      // Gain slider is the real control we offer
      gain.value = String(Math.round(clamp(state.settings.gain,0,2) * 100));
      updateVolumeHint();
      applyGain();
    }

    // ========= Kickstart WebAudio on first user interaction =========
    const prime = async () => {
      ensureWebAudio();
      await resumeAudioContextIfNeeded();
      window.removeEventListener('touchstart', prime, {passive:true});
      window.removeEventListener('click', prime);
      applyGain();
    };
    window.addEventListener('touchstart', prime, {passive:true, once:true});
    window.addEventListener('click', prime, {once:true});

    // ========= Init =========
    hydrate();
    initVolumeUI();

  })();
  </script>
</body>
</html>
